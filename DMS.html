<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Connecting...</title>
</head>
<body style="font-family:Arial;text-align:center;padding-top:40px">

<h3>Establishing secure session‚Ä¶</h3>
<p>Please wait</p>

<script>
  const params = new URLSearchParams(location.search);
  const token = params.get("t");

  if (!token) {
    document.body.innerHTML = "<h3>Invalid request</h3>";
    throw new Error("No token");
  }

  // üîê TOKEN STORAGE
  const USED_KEY = "maha_used_tokens";
  const used = JSON.parse(localStorage.getItem(USED_KEY) || "[]");

  // ‚ùå Already used
  if (used.includes(token)) {
    document.body.innerHTML = `
      <h3>Link already used</h3>
      <p>Please click again from MAHA portal.</p>
    `;
    throw new Error("Token reused");
  }

  // üî• BURN TOKEN IMMEDIATELY
  used.push(token);
  localStorage.setItem(USED_KEY, JSON.stringify(used));

  // Decode
  let data;
  try {
    data = JSON.parse(atob(token));
  } catch {
    document.body.innerHTML = "<h3>Invalid token</h3>";
    throw new Error("Corrupt token");
  }

  // ‚ùå Internet check
  if (!navigator.onLine) {
    document.body.innerHTML = `
      <h3>No internet</h3>
      <p>Please connect internet and retry.</p>
    `;
    throw new Error("Offline");
  }

  // üîê VPN reachability check
  fetch(data.url, {
    method: "HEAD",
    mode: "no-cors",
    cache: "no-store"
  })
  .then(() => {
    // ‚úÖ Redirect & history wipe
    window.location.replace(data.url);
  })
  .catch(() => {
    document.body.innerHTML = `
      <h3>CISCO VPN not connected</h3>
      <p>Please connect and try again.</p>
    `;
  });
</script>

</body>
</html>
