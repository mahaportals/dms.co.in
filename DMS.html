<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Connecting...</title>
</head>
<body style="font-family:Arial;text-align:center;padding-top:40px">

<h3>Establishing secure session‚Ä¶</h3>
<p>Please wait</p>

<script defer>
  const params = new URLSearchParams(location.search);
  const token = params.get("t");

  if (!token) {
    document.body.innerHTML = "<h3>Invalid request</h3>";
    throw new Error("No token");
  }

  // üîê TOKEN STORAGE
  const USED_KEY = "maha_used_tokens";
  const used = JSON.parse(localStorage.getItem(USED_KEY) || "[]");

  if (used.includes(token)) {
    document.body.innerHTML = `
      <h3>Link already used</h3>
      <p>Please click again from MAHA portal.</p>
    `;
    throw new Error("Token reused");
  }

  used.push(token);
  localStorage.setItem(USED_KEY, JSON.stringify(used));

  // Convert URL-safe Base64 to standard Base64
  function urlSafeBase64Decode(str) {
    str = str.replace(/-/g, '+').replace(/_/g, '/');
    // Add padding if needed
    while (str.length % 4) str += '=';
    return atob(str);
  }

  let data;
  try {
    data = JSON.parse(urlSafeBase64Decode(token));
  } catch {
    document.body.innerHTML = "<h3>Invalid token</h3>";
    throw new Error("Corrupt token");
  }

  if (!navigator.onLine) {
    document.body.innerHTML = `
      <h3>No internet</h3>
      <p>Please connect internet and retry.</p>
    `;
    throw new Error("Offline");
  }

  // ‚úÖ Redirect
  try {
    window.location.replace(data.url);
  } catch (e) {
    document.body.innerHTML = `
      <h3>CISCO VPN not connected</h3>
      <p>Please connect and try again.</p>
    `;
  }
</script>

</body>
</html>
